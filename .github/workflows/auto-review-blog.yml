name: Amazon Q Pipeline
on:
  pull_request:
    branches:
      - main

permissions:
  id-token: write

jobs:
  AmazonQCodeReview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Install Amazon Q
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://desktop-release.q.us-east-1.amazonaws.com/latest/amazon-q.deb -o amazon-q.deb
          sudo apt install -y ./amazon-q.deb
          rm amazon-q.deb
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::861276113617:role/RybrowGithubActionsRole
          aws-region: ap-southeast-2
      - name: Pull Amazon Q Authentication
        run: aws s3 sync s3://rybrow-amazon-q-cicd-blog/authentication ~/.local/share/amazon-q/
      - name: Run Amazon Q
        run: q chat --accept-all -- "--command /review Do a code review for any Critical, or High security issues in my workspace"
